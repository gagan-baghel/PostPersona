# PersonaPost V1

A sophisticated LinkedIn content creation platform that enables users to generate authentic, persona-driven posts using AI avatars. Built with Next.js 16, Supabase, and the Vercel AI SDK.

---

## Overview

PersonaPost transforms LinkedIn content creation by allowing users to create and manage AI-powered personas (avatars) that generate posts matching specific personalities, writing styles, and professional voices. The app provides a complete workflow: avatar management, post generation with optional AI-generated images, LinkedIn-style previewing, comprehensive history tracking, and a monetizable coin purchase system.

**Key Features:**
- ğŸ­ Avatar Management - Create, edit, and organize AI personas with detailed personality profiles
- âœï¸ Sequential Post Generation - AI-powered post creation with optional image generation
- ğŸ’° Coin Purchase System - Stripe integration with secure dummy mode for testing
- ğŸ’³ Transaction History - Complete audit trail of all coin purchases and usage
- ğŸ“± LinkedIn Preview - Realistic post previews before publishing
- ğŸ“œ Post History - Complete archive with images and metadata
- ğŸ” Secure Authentication - Supabase Auth with Row Level Security
- ğŸ¨ Dark Mode UI - Modern, accessible interface with sophisticated design

---

## Tech Stack

### Frontend
- **Next.js 16** - React framework with App Router, Server Components, and Server Actions
- **React 19.2** - Latest React features including useEffectEvent
- **TypeScript** - Type-safe development
- **Tailwind CSS v4** - Utility-first styling with semantic design tokens
- **shadcn/ui** - Accessible, customizable component library
- **Vercel AI SDK v5** - AI integration with streaming support

### Backend & Database
- **Supabase** - PostgreSQL database, authentication, and real-time subscriptions
- **Stripe** - Payment processing for coin purchases
- **Row Level Security (RLS)** - Database-level access control
- **SQL Scripts** - Version-controlled schema migrations

---

## Environment Variables

All environment variables are automatically provided when the Supabase integration is connected. The following variables are required:

### Supabase (Required)
```bash
# Supabase Connection
SUPABASE_URL=                        # Your Supabase project URL
SUPABASE_ANON_KEY=                   # Public anonymous key
SUPABASE_SERVICE_ROLE_KEY=           # Service role key (server-only)
NEXT_PUBLIC_SUPABASE_URL=            # Client-side URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=       # Client-side anonymous key

# Development Redirect
NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL=http://localhost:3000
```

### PostgreSQL (Auto-generated by Supabase)
```bash
POSTGRES_URL=                        # Connection pooler URL
POSTGRES_PRISMA_URL=                 # Prisma-specific URL
POSTGRES_URL_NON_POOLING=           # Direct connection URL
POSTGRES_HOST=                       # Database host
POSTGRES_USER=                       # Database user
POSTGRES_PASSWORD=                   # Database password
POSTGRES_DATABASE=                   # Database name
```

### Stripe (Required for Production)
```bash
# Stripe API Keys
STRIPE_SECRET_KEY=                   # Stripe secret key (server-only)
STRIPE_PUBLISHABLE_KEY=              # Stripe publishable key
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=  # Client-side publishable key
STRIPE_WEBHOOK_SECRET=               # Webhook signing secret

# Note: Webhook URL must be configured in Stripe dashboard:
# https://yourdomain.com/api/webhooks/stripe
```

**Note:** The coin purchase system has two modes:
- **Dummy Mode** (default): Instantly adds coins without payment processing - perfect for testing
- **Production Mode**: Full Stripe integration with embedded checkout and webhooks

---

## Local Setup

### Prerequisites
- Node.js 18+ and pnpm
- Supabase account and project
- Git

### Installation Steps

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd personapost-v1
   ```

2. **Install dependencies**
   ```bash
   pnpm install
   ```

3. **Configure Supabase integration**
   - Connect your Supabase project via the v0 interface
   - All environment variables will be automatically configured
   - Alternatively, copy `.env.example` to `.env.local` and add your keys manually

4. **Run database migrations**
   ```bash
   # Execute SQL scripts in order from the v0 interface
   # Or run them manually in Supabase SQL Editor:
   scripts/001_create_tables.sql
   scripts/002_create_profile_trigger.sql
   scripts/003_add_coins_and_image_features.sql
   scripts/004_insert_suggested_avatars.sql
   scripts/005_add_transactions_table.sql
   ```

5. **Start development server**
   ```bash
   pnpm dev
   ```

6. **Open the app**
   ```
   http://localhost:3000
   ```

---

## Project Structure

```
personapost-v1/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ api/                      # Backend API routes
â”‚   â”‚   â”œâ”€â”€ coins/                # Coin purchase system
â”‚   â”‚   â”‚   â”œâ”€â”€ create-checkout/  # Create Stripe session
â”‚   â”‚   â”‚   â””â”€â”€ dummy-purchase/   # Dummy mode coin addition
â”‚   â”‚   â”œâ”€â”€ webhooks/             # Webhook handlers
â”‚   â”‚   â”‚   â””â”€â”€ stripe/           # Stripe payment webhooks
â”‚   â”‚   â”œâ”€â”€ deduct-coins/         # Coin deduction endpoint
â”‚   â”‚   â”œâ”€â”€ generate-post/        # Post generation (dummy AI)
â”‚   â”‚   â”œâ”€â”€ post-to-linkedin/     # LinkedIn posting (dummy)
â”‚   â”‚   â””â”€â”€ save-post/            # Save post to database
â”‚   â”œâ”€â”€ auth/                     # Authentication pages
â”‚   â”‚   â”œâ”€â”€ login/                # Sign in page
â”‚   â”‚   â”œâ”€â”€ sign-up/              # Sign up page
â”‚   â”‚   â”œâ”€â”€ sign-up-success/      # Email confirmation screen
â”‚   â”‚   â””â”€â”€ error/                # Auth error handler
â”‚   â”œâ”€â”€ dashboard/                # Protected dashboard
â”‚   â”‚   â”œâ”€â”€ avatars/              # Avatar CRUD pages
â”‚   â”‚   â”‚   â”œâ”€â”€ new/              # Create avatar
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/edit/        # Edit avatar
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # Avatar list + Explore
â”‚   â”‚   â”œâ”€â”€ coins/                # Coin purchase pages
â”‚   â”‚   â”‚   â”œâ”€â”€ success/          # Payment success page
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # Buy coins page
â”‚   â”‚   â”œâ”€â”€ generate/             # Post generation flow
â”‚   â”‚   â”œâ”€â”€ history/              # Post archive
â”‚   â”‚   â”œâ”€â”€ settings/             # User settings
â”‚   â”‚   â”œâ”€â”€ layout.tsx            # Dashboard layout with sidebar + coin display
â”‚   â”‚   â””â”€â”€ page.tsx              # Dashboard home
â”‚   â”œâ”€â”€ pricing/                  # Pricing page
â”‚   â”œâ”€â”€ layout.tsx                # Root layout
â”‚   â”œâ”€â”€ page.tsx                  # Landing page
â”‚   â””â”€â”€ globals.css               # Global styles + design tokens
â”‚
â”œâ”€â”€ components/                   # React components
â”‚   â”œâ”€â”€ ui/                       # shadcn/ui primitives
â”‚   â”œâ”€â”€ avatar-card.tsx           # User avatar display
â”‚   â”œâ”€â”€ avatar-form.tsx           # Avatar creation/edit form
â”‚   â”œâ”€â”€ dashboard-nav.tsx         # Sidebar navigation
â”‚   â”œâ”€â”€ linkedin-preview-dialog.tsx  # LinkedIn post preview
â”‚   â”œâ”€â”€ post-card.tsx             # Post history item
â”‚   â”œâ”€â”€ post-generator.tsx        # Post generation component
â”‚   â”œâ”€â”€ settings-form.tsx         # User settings form
â”‚   â”œâ”€â”€ suggested-avatar-card.tsx # Explore avatar card
â”‚   â””â”€â”€ coin-purchase-client.tsx # Coin purchase client component
â”‚
â”œâ”€â”€ lib/                          # Utility libraries
â”‚   â”œâ”€â”€ supabase/                 # Supabase client utilities
â”‚   â”‚   â”œâ”€â”€ client.ts             # Browser client (singleton)
â”‚   â”‚   â”œâ”€â”€ server.ts             # Server client (RSC/actions)
â”‚   â”‚   â””â”€â”€ proxy.ts              # Cookie helpers for SSR
â”‚   â”œâ”€â”€ stripe.ts                 # Stripe configuration + coin packages
â”‚   â””â”€â”€ utils.ts                  # Helper functions (cn, etc.)
â”‚
â”œâ”€â”€ scripts/                      # SQL migrations
â”‚   â”œâ”€â”€ 001_create_tables.sql    # Initial schema
â”‚   â”œâ”€â”€ 002_create_profile_trigger.sql  # Profile automation
â”‚   â”œâ”€â”€ 003_add_coins_and_image_features.sql  # Coins + image fields
â”‚   â”œâ”€â”€ 004_insert_suggested_avatars.sql  # Default avatars
â”‚   â””â”€â”€ 005_add_transactions_table.sql  # Transaction audit trail

â”œâ”€â”€ proxy.ts                      # Middleware for auth
â”œâ”€â”€ next.config.mjs               # Next.js configuration
â”œâ”€â”€ tsconfig.json                 # TypeScript configuration
â””â”€â”€ README.md                     # This file
```

---

## Database Schema

### Tables

**profiles** - User profiles with coin balances
- `id` (uuid, FK to auth.users)
- `email` (text)
- `full_name` (text, nullable)
- `coins` (integer, default 1000)
- `linkedin_connected` (boolean, default false)
- `created_at`, `updated_at` (timestamps)

**avatars** - AI personas for content generation
- `id` (uuid, primary key)
- `user_id` (uuid, FK to profiles)
- `name` (text)
- `title` (text, nullable)
- `personality` (text)
- `writing_style` (text)
- `avatar_url` (text, nullable)
- `is_suggested` (boolean, default false)
- `created_at`, `updated_at` (timestamps)

**posts** - Generated LinkedIn posts
- `id` (uuid, primary key)
- `user_id` (uuid, FK to profiles)
- `avatar_id` (uuid, FK to avatars)
- `topic` (text)
- `content` (text)
- `image_url` (text, nullable)
- `image_prompt` (text, nullable)
- `image_preset` (text, nullable)
- `posted_to_linkedin` (boolean, default false)
- `posted_at` (timestamp, nullable)
- `created_at` (timestamp)

**transactions** - Coin purchase and usage audit trail
- `id` (uuid, primary key)
- `user_id` (uuid, FK to profiles)
- `type` (text: 'purchase', 'deduction', 'refund', 'bonus')
- `amount` (integer)
- `balance_after` (integer)
- `description` (text, nullable)
- `stripe_payment_intent_id` (text, nullable)
- `metadata` (jsonb)
- `created_at` (timestamp)

### Row Level Security (RLS)

All tables have RLS enabled with policies ensuring users can only:
- SELECT their own data
- INSERT data with their own user_id
- UPDATE their own records
- DELETE their own records

Exception: Suggested avatars (is_suggested = true) are readable by all authenticated users.

---

## Authentication Flow

1. **Sign Up**
   - User creates account with email/password
   - Supabase sends confirmation email
   - Redirects to `/auth/sign-up-success` with instructions
   - Email link confirms account and redirects to app

2. **Sign In**
   - Email/password authentication
   - Session stored in HTTP-only cookies
   - Middleware validates session on protected routes

3. **Sign Out**
   - Confirmation dialog prevents accidental sign-out
   - Invalidates Supabase session
   - Clears localStorage and sessionStorage
   - Redirects to login with router.replace()
   - Full page refresh clears in-memory state

4. **Session Management**
   - `proxy.ts` middleware refreshes tokens automatically
   - Protected routes redirect to login if unauthenticated
   - Session persists across page reloads

---

## Coin Purchase System

PersonaPost includes a production-ready, monetizable coin purchase system with two modes for maximum flexibility during development and testing.

### Coin Packages

Three packages are available via Stripe integration:

| Package | Coins | Price | Per Coin | Best For |
|---------|-------|-------|----------|----------|
| Starter | 100 | $4.99 | $0.050 | Trying out the platform |
| Popular | 500 | $19.99 | $0.040 | Regular users |
| Best Value | 1000 | $34.99 | $0.035 | Power users |

### Operating Modes

**1. Dummy Mode (Default)**
- **Purpose**: Testing and development without real payments
- **Behavior**: Coins are added instantly to user accounts
- **Security**: Backend-validated to prevent abuse
- **Toggle**: Set `DUMMY_MODE = true` in `components/coin-purchase-client.tsx`
- **Use Case**: Development, testing, demos, QA environments

**2. Production Mode**
- **Purpose**: Real payments via Stripe
- **Behavior**: Full Stripe Checkout with embedded UI
- **Payment Flow**: 
  1. User selects package
  2. Embedded Stripe Checkout opens in dialog
  3. User completes payment
  4. Webhook processes payment and adds coins
  5. Redirect to success page
- **Toggle**: Set `DUMMY_MODE = false` in `components/coin-purchase-client.tsx`
- **Requirements**: Valid Stripe keys and webhook configuration

### Stripe Configuration

**Products Created:**
- `prod_TcXJtDiAehY0mS` - 100 Coins ($4.99)
- `prod_TcXJN87IwKihLm` - 500 Coins ($19.99)
- `prod_TcXJukhWcC6TyT` - 1000 Coins ($34.99)

**Webhook Setup:**
1. Go to Stripe Dashboard â†’ Developers â†’ Webhooks
2. Add endpoint: `https://yourdomain.com/api/webhooks/stripe`
3. Select event: `checkout.session.completed`
4. Copy webhook signing secret to `STRIPE_WEBHOOK_SECRET`

### Transaction Tracking

All coin purchases and deductions are logged in the `transactions` table:
- **Purchase**: Successful Stripe payment
- **Deduction**: Post or image generation
- **Refund**: Refunded payment (manual)
- **Bonus**: Promotional credits (manual)

Each transaction records:
- Amount changed
- Balance after transaction
- Description
- Stripe payment intent ID (if applicable)
- Custom metadata (package ID, mode, etc.)

### Security Considerations

**Dummy Mode:**
- Backend endpoint validates all inputs
- Rate limiting recommended for production
- Should be disabled in public environments
- Logs all dummy transactions for audit

**Production Mode:**
- Webhook signatures verified cryptographically
- Idempotent transaction processing
- Race condition protection via atomic updates
- Full PCI compliance through Stripe

### Usage Example

```typescript
// User clicks "Buy 500 Coins"
// Dummy mode: Instant coin addition
await fetch('/api/coins/dummy-purchase', {
  method: 'POST',
  body: JSON.stringify({ coins: 500, packageId: '500' })
})

// Production mode: Stripe Checkout
const session = await fetch('/api/coins/create-checkout', {
  method: 'POST',
  body: JSON.stringify({ 
    priceId: 'price_1SfIGAEKqulcziPpaP11W4TC',
    coins: 500 
  })
})
// User completes payment in embedded Stripe UI
// Webhook handler processes payment and adds coins
```

### Deployment Checklist

Before going live with coin purchases:
- [ ] Set `DUMMY_MODE = false` in client component
- [ ] Configure Stripe webhook endpoint
- [ ] Add `STRIPE_WEBHOOK_SECRET` environment variable
- [ ] Test payment flow in Stripe test mode
- [ ] Verify webhook delivery in Stripe dashboard
- [ ] Test refund flow
- [ ] Set up monitoring for failed payments
- [ ] Configure email receipts in Stripe
- [ ] Add terms of service and refund policy
- [ ] Consider fraud detection and rate limiting

---

## Troubleshooting

**Sign-up email not received:**
- Check Supabase Auth settings â†’ Email Templates
- Verify SMTP configuration in Supabase project
- Check spam folder
- Ensure `NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL` is set

**RLS policy errors:**
- Verify user is authenticated (`supabase.auth.getUser()`)
- Check `user_id` matches authenticated user
- Review policies in Supabase dashboard â†’ Authentication â†’ Policies

**Coins not deducting:**
- Check API route responses in Network tab
- Verify sufficient balance before operation
- Ensure atomic transactions in `deduct-coins` route
- Check for race conditions (multiple rapid clicks)

**Stripe checkout not working:**
- Verify `STRIPE_PUBLISHABLE_KEY` is set in environment
- Check `DUMMY_MODE` flag in coin-purchase-client component
- Ensure Stripe products and prices exist
- Check browser console for Stripe.js errors

**Webhook not receiving events:**
- Verify webhook URL in Stripe dashboard
- Check `STRIPE_WEBHOOK_SECRET` environment variable
- Test webhook locally using Stripe CLI
- Review Stripe dashboard â†’ Developers â†’ Webhooks for delivery logs

---

## Future Enhancements

### Phase 1: Real AI Integration
- [ ] Replace dummy post generation with OpenAI GPT-4
- [ ] Add streaming response from AI SDK
- [ ] Implement real image generation (fal.ai)
- [ ] Add prompt engineering for persona consistency

### Phase 2: LinkedIn Integration
- [ ] OAuth flow for LinkedIn connection
- [ ] Real posting to LinkedIn API
- [ ] Schedule posts for later
- [ ] Analytics on post performance

### Phase 3: Enhanced Features
- [ ] Team workspaces and shared avatars
- [ ] Post templates and style presets
- [ ] A/B testing for post variations
- [ ] Content calendar and planning

### Phase 4: Monetization
- [x] Stripe integration for coin purchases
- [x] Transaction history and audit trail
- [x] Embedded Stripe Checkout UI
- [x] Webhook processing for payments
- [ ] Subscription tiers (Free, Pro, Team)
- [ ] Usage analytics dashboard
- [ ] Referral program

---

## Contributing

This is a v0-generated project. For production use:
1. Replace all dummy AI implementations
2. Add comprehensive error handling
3. Implement rate limiting
4. Add monitoring and logging
5. Write unit and integration tests
6. Set up CI/CD pipeline
7. Configure production environment variables
8. Enable Vercel Analytics

---

## License

Proprietary - All rights reserved

---

## Support

For issues or questions:
- Check this README first
- Review Supabase docs: https://supabase.com/docs
- Check Next.js docs: https://nextjs.org/docs
- Review AI SDK docs: https://sdk.vercel.ai

---

**Built with â¤ï¸ using v0 by Vercel**
